---
import Base from '@layouts/base.astro';
---

<Base title="Search" description="Search articles, reviews, and podcasts">
  <div data-pagefind-ignore>
    <h2>Search</h2>
    <div id="searchContainer">
      <input
        type="search"
        id="searchInput"
        placeholder="Enter query..."
        autocomplete="off"
        aria-label="Search site content"
      />
    </div>
    <fieldset>
      <legend>Search result filters</legend>
      <ul>
        <li>
          <input
            type="checkbox"
            id="articleFilter"
            name="searchFilter"
            value="article"
            checked
          />
          <label for="articleFilter">Articles</label>
        </li>
        <li>
          <input
            type="checkbox"
            id="podcastFilter"
            name="searchFilter"
            value="podcast"
            checked
          />
          <label for="podcastFilter">Podcasts</label>
        </li>
        <li>
          <input
            type="checkbox"
            id="reviewFilter"
            name="searchFilter"
            value="review"
            checked
          />
          <label for="reviewFilter">Reviews</label>
        </li>
      </ul>
    </fieldset>
    <dl id="searchResults" aria-live="polite"></dl>
    <template id="searchResultTemplate">
      <dt class="searchResult">
        <a href=""></a>
      </dt>
      <dd class="excerpt"></dd>
    </template>
  </div>
</Base>

<style>
  #searchInput {
    width: 100%;
  }
  ul {
    display: flex;
    justify-content: space-evenly;
    list-style: none;
  }
  #searchResults {
    margin-top: 1rem;
  }
</style>

<script>
  type SearchResult = {
    url: string;
    meta?: { title?: string };
    excerpt: string;
  };
  type Pagefind = {
    init: () => Promise<void>;
    debouncedSearch: (
      query: string,
      options?: { filters?: { [key: string]: { any: string[] } } },
    ) => Promise<{ results: { data: () => Promise<SearchResult> }[] } | null>;
  };

  const searchField = document.querySelector<HTMLInputElement>('#searchInput')!;
  const resultsContainer =
    document.querySelector<HTMLDListElement>('#searchResults')!;
  const template = document.querySelector<HTMLTemplateElement>(
    '#searchResultTemplate',
  )!;
  const fieldset = document.querySelector<HTMLFieldSetElement>('fieldset')!;
  let pagefind: Pagefind | null = null;

  async function loadPagefind() {
    if (pagefind) return pagefind;

    if (import.meta.env.DEV) {
      console.warn(
        'Search is unavailable in dev mode. Run `bun run build` first.',
      );
      return null;
    }

    try {
      // @ts-expect-error - pagefind is generated at build time
      const pf = await import('/pagefind/pagefind.js');
      await pf.init();
      pagefind = pf;
      return;
    } catch (error) {
      console.error('Failed to load Pagefind:', error);
      throw error;
    }
  }

  function getSelectedFilters(): string[] {
    return Array.from(
      fieldset.querySelectorAll<HTMLInputElement>(
        'input[name="searchFilter"]:checked',
      ),
    ).map((el) => el.value);
  }

  function renderResult(data: SearchResult) {
    const clone = document.importNode(template.content, true);
    const link = clone.querySelector('a')!;
    const excerptEl = clone.querySelector('.excerpt')!;

    link.href = data.url;
    link.textContent = data.meta?.title || data.url;
    (excerptEl as HTMLElement).innerHTML = data.excerpt;

    return clone;
  }

  async function getSearchResults(query: string, filters: string[]) {
    if (!query.trim()) {
      resultsContainer.replaceChildren();
      return;
    }

    try {
      await loadPagefind();
      if (!pagefind) return;

      const options = filters.length
        ? { filters: { category: { any: filters } } }
        : {};
      const response = await pagefind.debouncedSearch(query, options);

      if (!response) return; // superseded by newer search

      const results = await Promise.all(
        response.results.slice(0, 10).map((r) => r.data()),
      );

      resultsContainer.replaceChildren(...results.map(renderResult));
    } catch (error) {
      console.error('Search failed:', error);
    }
  }

  const triggerSearch = () =>
    getSearchResults(searchField.value, getSelectedFilters());

  searchField.addEventListener('focus', loadPagefind, { once: true });
  searchField.addEventListener('input', triggerSearch);

  fieldset.addEventListener('change', (e) => {
    if ((e.target as HTMLInputElement)?.name === 'searchFilter')
      triggerSearch();
  });
</script>
